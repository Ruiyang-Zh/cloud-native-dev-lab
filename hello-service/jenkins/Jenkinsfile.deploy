pipeline {
    agent any

    parameters {
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'è¦éƒ¨ç½²çš„é•œåƒæ ‡ç­¾')
        string(name: 'FULL_IMAGE_NAME', defaultValue: '', description: 'å®Œæ•´çš„é•œåƒåç§°')
    }

    environment {
        // å¦‚æœæœ‰kubeconfigå‡­æ®ï¼Œå–æ¶ˆæ³¨é‡Šä¸‹ä¸€è¡Œ
        // KUBECONFIG = credentials('kubeconfig')

        DOCKER_REGISTRY = '172.22.83.19:30003'
        IMAGE_NAMESPACE = 'nju14'
        IMAGE_NAME = 'hello-service'
        K8S_NAMESPACE = 'default'
        DEPLOYMENT_NAME = 'hello-service'
        PROJECT_DIR = "hello-service"
    }

    stages {
        stage('å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ') {
            steps {
                echo "ğŸš€ å¼€å§‹éƒ¨ç½²é•œåƒ: ${params.FULL_IMAGE_NAME}"
                echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${params.IMAGE_TAG}"

                // å¦‚æœæœ‰kubeconfigï¼ŒéªŒè¯kubectlè¿æ¥
                script {
                    try {
                        sh '''
                            echo "=== éªŒè¯Kubernetesè¿æ¥ ==="
                            kubectl version --client
                            kubectl cluster-info
                            kubectl get nodes
                            echo "âœ… K8sè¿æ¥æ­£å¸¸"
                        '''
                    } catch (Exception e) {
                        echo "âš ï¸ æ— kubeconfigé…ç½®ï¼Œå°†ç”Ÿæˆéƒ¨ç½²æ–‡ä»¶ä¾›æ‰‹åŠ¨éƒ¨ç½²"
                    }
                }
            }
        }

        stage('æ›´æ–°éƒ¨ç½²æ–‡ä»¶') {
            steps {
                echo 'ğŸ“ æ›´æ–°Kuberneteséƒ¨ç½²æ–‡ä»¶...'
                script {
                    // æ‹‰å–æœ€æ–°ä»£ç ä»¥è·å–k8sé…ç½®æ–‡ä»¶
                    checkout scm

                    // â­ å…³é”®ï¼šè¯»å–é¡¹ç›®ç›®å½•ä¸­çš„k8sæ–‡ä»¶
                    def deploymentYaml = readFile("${PROJECT_DIR}/k8s/deployment.yaml")

                    // è®¡ç®—è¦ä½¿ç”¨çš„é•œåƒ
                    def imageToUse = params.FULL_IMAGE_NAME ?: "${DOCKER_REGISTRY}/${IMAGE_NAMESPACE}/${IMAGE_NAME}:${params.IMAGE_TAG}"

                    // æ›¿æ¢é•œåƒåœ°å€
                    deploymentYaml = deploymentYaml.replaceAll('172.22.83.19:30003/nju14/hello-service:latest', imageToUse)

                    // å†™å…¥ä¸´æ—¶æ–‡ä»¶
                    writeFile file: 'deployment-updated.yaml', text: deploymentYaml

                    echo "âœ… éƒ¨ç½²æ–‡ä»¶æ›´æ–°å®Œæˆ"
                    echo "ğŸ³ ä½¿ç”¨é•œåƒ: ${imageToUse}"

                    // æ˜¾ç¤ºæ›´æ–°åçš„é•œåƒé…ç½®
                    sh '''
                        echo "=== éªŒè¯é•œåƒé…ç½® ==="
                        grep -n "image:" deployment-updated.yaml || echo "æœªæ‰¾åˆ°imageé…ç½®"
                    '''
                }
            }
        }

        stage('éƒ¨ç½²åˆ°Kubernetes') {
            steps {
                echo 'ğŸ¯ å¼€å§‹éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤...'
                script {
                    try {
                        sh '''
                            echo "=== åº”ç”¨Kubernetesèµ„æº ==="

                            # éƒ¨ç½²åº”ç”¨
                            kubectl apply -f deployment-updated.yaml
                            echo "âœ… Deploymentå·²æ›´æ–°"

                            # éƒ¨ç½²æœåŠ¡
                            kubectl apply -f ${PROJECT_DIR}/k8s/service.yaml
                            echo "âœ… Serviceå·²æ›´æ–°"

                            # éƒ¨ç½²ç›‘æ§é…ç½®
                            kubectl apply -f ${PROJECT_DIR}/k8s/servicemonitor.yaml
                            echo "âœ… ServiceMonitorå·²æ›´æ–°"

                            # éƒ¨ç½²HPA
                            kubectl apply -f ${PROJECT_DIR}/k8s/hpa.yaml
                            echo "âœ… HPAå·²æ›´æ–°"

                            echo "ğŸ‰ æ‰€æœ‰Kubernetesèµ„æºéƒ¨ç½²å®Œæˆ"
                        '''
                    } catch (Exception e) {
                        echo "âš ï¸ kubectléƒ¨ç½²å¤±è´¥ï¼Œå¯èƒ½æ˜¯kubeconfigæœªé…ç½®"
                        echo "ğŸ“‹ ç”Ÿæˆæ‰‹åŠ¨éƒ¨ç½²è¯´æ˜..."
                        sh '''
                            echo "=== æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤ ==="
                            echo "kubectl apply -f deployment-updated.yaml"
                            echo "kubectl apply -f ${PROJECT_DIR}/k8s/service.yaml"
                            echo "kubectl apply -f ${PROJECT_DIR}/k8s/servicemonitor.yaml"
                            echo "kubectl apply -f ${PROJECT_DIR}/k8s/hpa.yaml"
                        '''
                        // å½’æ¡£éƒ¨ç½²æ–‡ä»¶
                        archiveArtifacts artifacts: 'deployment-updated.yaml,hello-service/k8s/*.yaml', fingerprint: true
                    }
                }
            }
        }

        stage('éªŒè¯éƒ¨ç½²') {
            steps {
                echo 'ğŸ” éªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸ...'
                script {
                    try {
                        sh '''
                            echo "=== æ£€æŸ¥æœåŠ¡çŠ¶æ€ ==="
                            kubectl get svc ${DEPLOYMENT_NAME}
                            kubectl get svc ${DEPLOYMENT_NAME}-lb 2>/dev/null || echo "LoadBalanceræœåŠ¡æœªé…ç½®"

                            echo "=== æ£€æŸ¥ç«¯ç‚¹ ==="
                            kubectl get endpoints ${DEPLOYMENT_NAME}

                            echo "=== è·å–Podè¿›è¡Œå¥åº·æ£€æŸ¥ ==="
                            POD_NAME=$(kubectl get pods -l app=${DEPLOYMENT_NAME} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)

                            if [ -n "$POD_NAME" ]; then
                                echo "æµ‹è¯•Pod: $POD_NAME"

                                # ç­‰å¾…Podå°±ç»ª
                                kubectl wait --for=condition=ready pod/$POD_NAME --timeout=120s

                                # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
                                echo "=== æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹ ==="
                                kubectl exec $POD_NAME -- curl -f http://localhost:8080/actuator/health

                                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                            else
                                echo "âŒ æœªæ‰¾åˆ°å¯ç”¨çš„Pod"
                                exit 1
                            fi
                        '''
                    } catch (Exception e) {
                        echo "âš ï¸ è‡ªåŠ¨éªŒè¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥éƒ¨ç½²çŠ¶æ€"
                    }
                }
            }
        }

        stage('çƒŸé›¾æµ‹è¯•') {
            steps {
                echo 'ğŸ§ª æ‰§è¡ŒçƒŸé›¾æµ‹è¯•...'
                script {
                    try {
                        sh '''
                            echo "=== é€šè¿‡Serviceæµ‹è¯•æ¥å£ ==="
                            SERVICE_IP=$(kubectl get svc ${DEPLOYMENT_NAME} -o jsonpath='{.spec.clusterIP}')
                            echo "Service IP: $SERVICE_IP"

                            # åˆ›å»ºä¸´æ—¶Podè¿›è¡Œæµ‹è¯•
                            echo "=== åˆ›å»ºæµ‹è¯•Pod ==="
                            kubectl run test-pod-${BUILD_NUMBER} --image=curlimages/curl:latest --rm -i --restart=Never -- \
                                curl -f -m 10 http://${DEPLOYMENT_NAME}.${K8S_NAMESPACE}.svc.cluster.local/hello

                            echo "âœ… çƒŸé›¾æµ‹è¯•é€šè¿‡"

                            # æµ‹è¯•é™æµæ¥å£
                            echo "=== æµ‹è¯•é™æµåŠŸèƒ½ ==="
                            kubectl run test-ratelimit-${BUILD_NUMBER} --image=curlimages/curl:latest --rm -i --restart=Never -- \
                                sh -c 'for i in $(seq 1 5); do echo "Request $i:"; curl -f http://hello-service.default.svc.cluster.local/hello; echo; done'

                            echo "âœ… é™æµæµ‹è¯•å®Œæˆ"
                        '''
                    } catch (Exception e) {
                        echo "âš ï¸ çƒŸé›¾æµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨éªŒè¯"
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'ğŸ CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ'
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            sh 'rm -f deployment-updated.yaml || true'

            // æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
            sh '''
                echo "=== éƒ¨ç½²æ‘˜è¦ ==="
                echo "éƒ¨ç½²é•œåƒ: ${FULL_IMAGE_NAME:-${DOCKER_REGISTRY}/${IMAGE_NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG}}"
                echo "å‘½åç©ºé—´: ${K8S_NAMESPACE}"
                echo "éƒ¨ç½²åç§°: ${DEPLOYMENT_NAME}"
                echo "é¡¹ç›®ç›®å½•: ${PROJECT_DIR}"
                echo "====================="
            '''
        }
        success {
            echo 'ğŸ‰ CDæµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼åº”ç”¨éƒ¨ç½²å®Œæˆ'
            echo "ğŸ“ å¦‚æœæ— æ³•è‡ªåŠ¨éƒ¨ç½²ï¼Œéƒ¨ç½²æ–‡ä»¶å·²å½’æ¡£ï¼Œå¯æ‰‹åŠ¨æ‰§è¡Œ"
        }
        failure {
            echo 'âŒ CDæµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼'
            echo "ğŸ“‹ è¯·æ£€æŸ¥kubeconfigé…ç½®æˆ–æ‰‹åŠ¨éƒ¨ç½²"
        }
    }
}