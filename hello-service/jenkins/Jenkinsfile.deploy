pipeline {
    agent any

    parameters {
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'è¦éƒ¨ç½²çš„é•œåƒæ ‡ç­¾')
        string(name: 'FULL_IMAGE_NAME', defaultValue: '', description: 'å®Œæ•´çš„é•œåƒåç§°')
    }

    environment {
        // K8sé…ç½® - éœ€è¦åœ¨Jenkinsä¸­é…ç½®kubeconfigå‡­æ®
        KUBECONFIG = credentials('kubeconfig')

        // é•œåƒä»“åº“é…ç½®
        DOCKER_REGISTRY = '172.22.83.19:30003'
        IMAGE_NAMESPACE = 'nju14'
        IMAGE_NAME = 'hello-service'

        // éƒ¨ç½²é…ç½®
        K8S_NAMESPACE = 'default'
        DEPLOYMENT_NAME = 'hello-service'
    }

    stages {
        stage('å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ') {
            steps {
                echo "ğŸš€ å¼€å§‹éƒ¨ç½²é•œåƒ: ${params.FULL_IMAGE_NAME}"
                echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${params.IMAGE_TAG}"

                // éªŒè¯kubectlè¿æ¥
                sh '''
                    echo "=== éªŒè¯Kubernetesè¿æ¥ ==="
                    kubectl version --client
                    kubectl cluster-info
                    kubectl get nodes
                    echo "âœ… K8sè¿æ¥æ­£å¸¸"
                '''
            }
        }

        stage('æ›´æ–°éƒ¨ç½²æ–‡ä»¶') {
            steps {
                echo 'ğŸ“ æ›´æ–°Kuberneteséƒ¨ç½²æ–‡ä»¶...'
                script {
                    // æ‹‰å–æœ€æ–°ä»£ç ä»¥è·å–k8sé…ç½®æ–‡ä»¶
                    checkout scm

                    // è¯»å–deployment.yamlæ¨¡æ¿
                    def deploymentYaml = readFile('k8s/deployment.yaml')

                    // è®¡ç®—è¦ä½¿ç”¨çš„é•œåƒ
                    def imageToUse = params.FULL_IMAGE_NAME ?: "${DOCKER_REGISTRY}/${IMAGE_NAMESPACE}/${IMAGE_NAME}:${params.IMAGE_TAG}"

                    // æ›¿æ¢é•œåƒåœ°å€ - æ›´æ–°ä½ çš„deployment.yamlä¸­çš„é•œåƒåœ°å€
                    deploymentYaml = deploymentYaml.replaceAll('172.22.83.19:30003/nju14/hello-service:latest', imageToUse)

                    // å†™å…¥ä¸´æ—¶æ–‡ä»¶
                    writeFile file: 'deployment-updated.yaml', text: deploymentYaml

                    echo "âœ… éƒ¨ç½²æ–‡ä»¶æ›´æ–°å®Œæˆ"
                    echo "ğŸ³ ä½¿ç”¨é•œåƒ: ${imageToUse}"

                    // æ˜¾ç¤ºæ›´æ–°åçš„é•œåƒé…ç½®
                    sh '''
                        echo "=== éªŒè¯é•œåƒé…ç½® ==="
                        grep -n "image:" deployment-updated.yaml || echo "æœªæ‰¾åˆ°imageé…ç½®"
                    '''
                }
            }
        }

        stage('éƒ¨ç½²åˆ°Kubernetes') {
            steps {
                echo 'ğŸ¯ å¼€å§‹éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤...'
                sh '''
                    echo "=== åº”ç”¨Kubernetesèµ„æº ==="

                    # éƒ¨ç½²åº”ç”¨
                    kubectl apply -f deployment-updated.yaml
                    echo "âœ… Deploymentå·²æ›´æ–°"

                    # éƒ¨ç½²æœåŠ¡
                    kubectl apply -f k8s/service.yaml
                    echo "âœ… Serviceå·²æ›´æ–°"

                    # éƒ¨ç½²ç›‘æ§é…ç½®
                    kubectl apply -f k8s/servicemonitor.yaml
                    echo "âœ… ServiceMonitorå·²æ›´æ–°"

                    # éƒ¨ç½²HPA
                    kubectl apply -f k8s/hpa.yaml
                    echo "âœ… HPAå·²æ›´æ–°"

                    echo "ğŸ‰ æ‰€æœ‰Kubernetesèµ„æºéƒ¨ç½²å®Œæˆ"
                '''
            }
        }

        stage('ç­‰å¾…éƒ¨ç½²å®Œæˆ') {
            steps {
                echo 'â³ ç­‰å¾…Podå¯åŠ¨å®Œæˆ...'
                sh '''
                    echo "=== ç­‰å¾…éƒ¨ç½²æ»šåŠ¨æ›´æ–°å®Œæˆ ==="
                    kubectl rollout status deployment/${DEPLOYMENT_NAME} --timeout=300s

                    echo "=== æ£€æŸ¥PodçŠ¶æ€ ==="
                    kubectl get pods -l app=${DEPLOYMENT_NAME} -o wide

                    echo "=== æ£€æŸ¥DeploymentçŠ¶æ€ ==="
                    kubectl get deployment ${DEPLOYMENT_NAME}

                    echo "âœ… éƒ¨ç½²çŠ¶æ€æ£€æŸ¥å®Œæˆ"
                '''
            }
        }

        stage('éªŒè¯éƒ¨ç½²') {
            steps {
                echo 'ğŸ” éªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸ...'
                sh '''
                    echo "=== æ£€æŸ¥æœåŠ¡çŠ¶æ€ ==="
                    kubectl get svc ${DEPLOYMENT_NAME}
                    kubectl get svc ${DEPLOYMENT_NAME}-lb 2>/dev/null || echo "LoadBalanceræœåŠ¡æœªé…ç½®"

                    echo "=== æ£€æŸ¥ç«¯ç‚¹ ==="
                    kubectl get endpoints ${DEPLOYMENT_NAME}

                    echo "=== è·å–Podè¿›è¡Œå¥åº·æ£€æŸ¥ ==="
                    POD_NAME=$(kubectl get pods -l app=${DEPLOYMENT_NAME} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)

                    if [ -n "$POD_NAME" ]; then
                        echo "æµ‹è¯•Pod: $POD_NAME"

                        # ç­‰å¾…Podå°±ç»ª
                        kubectl wait --for=condition=ready pod/$POD_NAME --timeout=120s

                        # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
                        echo "=== æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹ ==="
                        kubectl exec $POD_NAME -- curl -f http://localhost:8080/actuator/health

                        echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                    else
                        echo "âŒ æœªæ‰¾åˆ°å¯ç”¨çš„Pod"
                        exit 1
                    fi
                '''
            }
        }

        stage('çƒŸé›¾æµ‹è¯•') {
            steps {
                echo 'ğŸ§ª æ‰§è¡ŒçƒŸé›¾æµ‹è¯•...'
                sh '''
                    echo "=== é€šè¿‡Serviceæµ‹è¯•æ¥å£ ==="
                    SERVICE_IP=$(kubectl get svc ${DEPLOYMENT_NAME} -o jsonpath='{.spec.clusterIP}')
                    echo "Service IP: $SERVICE_IP"

                    # åˆ›å»ºä¸´æ—¶Podè¿›è¡Œæµ‹è¯•
                    echo "=== åˆ›å»ºæµ‹è¯•Pod ==="
                    kubectl run test-pod-${BUILD_NUMBER} --image=curlimages/curl:latest --rm -i --restart=Never -- \
                        curl -f -m 10 http://${DEPLOYMENT_NAME}.${K8S_NAMESPACE}.svc.cluster.local/hello

                    echo "âœ… çƒŸé›¾æµ‹è¯•é€šè¿‡"

                    # æµ‹è¯•é™æµæ¥å£
                    echo "=== æµ‹è¯•é™æµåŠŸèƒ½ ==="
                    kubectl run test-ratelimit-${BUILD_NUMBER} --image=curlimages/curl:latest --rm -i --restart=Never -- \
                        sh -c 'for i in $(seq 1 5); do echo "Request $i:"; curl -f http://hello-service.default.svc.cluster.local/hello; echo; done'

                    echo "âœ… é™æµæµ‹è¯•å®Œæˆ"
                '''
            }
        }
    }

    post {
        always {
            echo 'ğŸ CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ'
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            sh 'rm -f deployment-updated.yaml || true'

            // æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
            sh '''
                echo "=== éƒ¨ç½²æ‘˜è¦ ==="
                echo "éƒ¨ç½²é•œåƒ: ${FULL_IMAGE_NAME:-${DOCKER_REGISTRY}/${IMAGE_NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG}}"
                echo "å‘½åç©ºé—´: ${K8S_NAMESPACE}"
                echo "éƒ¨ç½²åç§°: ${DEPLOYMENT_NAME}"
                echo "====================="
            '''
        }
        success {
            echo 'ğŸ‰ CDæµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼åº”ç”¨éƒ¨ç½²å®Œæˆ'
            script {
                // è·å–æœåŠ¡è®¿é—®ä¿¡æ¯
                def serviceInfo = sh(
                    script: '''
                        # å°è¯•è·å–LoadBalancerå¤–éƒ¨IP
                        LB_IP=$(kubectl get svc hello-service-lb -o jsonpath="{.status.loadBalancer.ingress[0].ip}" 2>/dev/null || echo "")
                        LB_PORT=$(kubectl get svc hello-service-lb -o jsonpath="{.spec.ports[0].port}" 2>/dev/null || echo "")
                        CLUSTER_IP=$(kubectl get svc hello-service -o jsonpath="{.spec.clusterIP}" 2>/dev/null || echo "")
                        NODE_PORT=$(kubectl get svc hello-service-lb -o jsonpath="{.spec.ports[0].nodePort}" 2>/dev/null || echo "")

                        if [ -n "$LB_IP" ] && [ -n "$LB_PORT" ]; then
                            echo "LoadBalancer: http://$LB_IP:$LB_PORT"
                        elif [ -n "$NODE_PORT" ]; then
                            echo "NodePort: http://NODE_IP:$NODE_PORT"
                        else
                            echo "ClusterIP: http://$CLUSTER_IP:80 (é›†ç¾¤å†…è®¿é—®)"
                        fi
                    ''',
                    returnStdout: true
                ).trim()

                echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€: ${serviceInfo}"

                // æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
                sh '''
                    echo "=== æœ€ç»ˆåº”ç”¨çŠ¶æ€ ==="
                    kubectl get deployment,svc,pods -l app=hello-service
                '''
            }
        }
        failure {
            echo 'âŒ CDæµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼'
            sh '''
                echo "=== éƒ¨ç½²å¤±è´¥è¯Šæ–­ä¿¡æ¯ ==="
                kubectl get pods -l app=hello-service
                kubectl describe deployment hello-service

                echo "=== æœ€è¿‘çš„Podäº‹ä»¶ ==="
                kubectl get events --sort-by=.metadata.creationTimestamp | tail -10

                echo "=== Podæ—¥å¿— (å¦‚æœå­˜åœ¨) ==="
                POD_NAME=$(kubectl get pods -l app=hello-service -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
                if [ -n "$POD_NAME" ]; then
                    kubectl logs $POD_NAME --tail=20 || echo "æ— æ³•è·å–Podæ—¥å¿—"
                else
                    echo "æœªæ‰¾åˆ°Pod"
                fi
            '''
        }
    }
}